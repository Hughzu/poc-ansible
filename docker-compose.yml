version: '3.8'

networks:
  ansible_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  ssh_keys:

services:
  ansible-control:
    image: ubuntu:22.04
    container_name: ansible-control
    hostname: ansible-control
    networks:
      ansible_network:
        ipv4_address: 172.20.0.10
    volumes:
      - ./ansible:/ansible
      - ssh_keys:/root/.ssh
    environment:
      - ANSIBLE_HOST_KEY_CHECKING=False
    command: >
      bash -c "
      echo 'ğŸš€ Starting Ansible Control Node setup...' &&
      echo 'ğŸ“¦ Updating package cache...' &&
      apt-get update && 
      echo 'ğŸ“¥ Installing required packages (python3, pip, ssh client, etc.)...' &&
      apt-get install -y python3 python3-pip openssh-client sshpass git vim &&
      echo 'ğŸ”§ Installing Ansible via pip...' &&
      pip3 install ansible &&
      echo 'ğŸ”‘ Setting up SSH key pair for passwordless access...' &&
      if [ ! -f /root/.ssh/id_rsa ]; then
        ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa -N '' -q
        echo 'âœ¨ New SSH key pair generated'
      else
        echo 'â™»ï¸ SSH key pair already exists, reusing...'
      fi &&
      echo 'ğŸ”§ Fixing directory permissions for ansible.cfg...' &&
      chmod 755 /ansible &&
      chmod 644 /ansible/ansible.cfg &&
      chmod 644 /ansible/inventory/hosts.yml &&
      echo 'âœ… Permissions fixed: ansible.cfg will now be recognized' &&
      echo 'ğŸ  Adding hostname mapping for webdev-01...' &&
      echo '172.20.0.11 webdev-01' >> /etc/hosts &&
      echo 'âœ… Ansible Control Node setup complete!' &&
      echo 'ğŸ’¡ You can now connect with: docker exec -it ansible-control bash' &&
      echo 'ğŸ¯ Next: cd /ansible && ansible all -m ping' &&
      echo 'ğŸ”— SSH test: ssh root@webdev-01' &&
      tail -f /dev/null
      "
    depends_on:
      - webdev-01
    restart: unless-stopped

  webdev-01:
    image: ubuntu:22.04
    container_name: webdev-01
    hostname: webdev-01
    networks:
      ansible_network:
        ipv4_address: 172.20.0.11
    environment:
      - DEBIAN_FRONTEND=noninteractive
    ports:
      - "8080:80"
    command: >
      bash -c "
      echo 'ğŸ¯ Starting Ubuntu Target Server setup...' &&
      echo 'ğŸ“¦ Updating package cache...' &&
      apt-get update &&
      echo 'ğŸ“¥ Installing SSH server, Python3, and sudo...' &&
      apt-get install -y openssh-server python3 sudo &&
      echo 'ğŸ“ Creating SSH daemon directory...' &&
      mkdir -p /var/run/sshd &&
      echo 'ğŸ“ Creating root SSH directory...' &&
      mkdir -p /root/.ssh &&
      echo 'ğŸ” Setting root password to: ansible123' &&
      echo 'root:ansible123' | chpasswd &&
      echo 'âš™ï¸ Configuring SSH: Enabling root login...' &&
      sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config &&
      echo 'âš™ï¸ Configuring SSH: Enabling password authentication...' &&
      sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config &&
      echo 'ğŸš€ Starting SSH service...' &&
      service ssh start &&
      echo 'âœ… Ubuntu Target Server ready!' &&
      echo 'ğŸ“¡ SSH server running on port 22' &&
      echo 'ğŸ”‘ Login: ssh root@172.20.0.11 (password: ansible123)' &&
      echo 'ğŸ’¡ Ready for Ansible connections!' &&
      tail -f /dev/null
      "
    restart: unless-stopped